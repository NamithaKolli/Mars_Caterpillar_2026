<root main_tree_to_execute="MainTree">

  <BehaviorTree ID="MainTree">
    <WhileDoElse name="MissionLoop">

      <!-- Continue loop while competition time remains -->
      <TimeRemaining/>

      <Sequence name="ExcavateDumpCycle">

        <!-- Navigate to Excavation Zone -->
        <SubTree ID="NavigateWithRecovery" goal="{excavate_pose}"/>

        <!-- Start Excavation (arrival_code = 0) -->
        <StartTask arrival_code="0"/>

        <!-- Navigate to Dumping Zone -->
        <SubTree ID="NavigateWithRecovery" goal="{dump_pose}"/>

        <!-- Start Dumping (arrival_code = 2) -->
        <StartTask arrival_code="2"/>

      </Sequence>

      <!-- If time is over, idle -->
      <Idle/>

    </WhileDoElse>
  </BehaviorTree>


  <!-- ========================================================= -->
  <!-- NAVIGATION SUBTREE WITH MULTI-LEVEL RECOVERY -->
  <!-- ========================================================= -->
  <BehaviorTree ID="NavigateWithRecovery">

    <RecoveryNode number_of_retries="6">

      <!-- Main Nav2 pipeline -->
      <PipelineSequence>

        <RateController hz="1.0">
          <RecoveryNode number_of_retries="1">
            <ComputePathToPose
              goal="{goal}"
              path="{path}"
              planner_id="GridBased"/>
            <ClearEntireCostmap
              service_name="global_costmap/clear_entirely_global_costmap"/>
          </RecoveryNode>
        </RateController>

        <RecoveryNode number_of_retries="1">
          <FollowPath
            path="{path}"
            controller_id="FollowPath"/>
          <ClearEntireCostmap
            service_name="local_costmap/clear_entirely_local_costmap"/>
        </RecoveryNode>

      </PipelineSequence>

      <!-- Physical recovery strategies -->
      <ReactiveFallback name="PhysicalRecovery">

        <!-- Level 1: Small backup -->
        <Sequence>
          <BackUp backup_dist="0.40" backup_speed="0.1"/>
          <ClearEntireCostmap service_name="local_costmap/clear_entirely_local_costmap"/>
        </Sequence>

        <!-- Level 2: Backup + turn -->
        <Sequence>
          <BackUp backup_dist="0.70" backup_speed="0.1"/>
          <Spin spin_dist="1.57"/>
          <ClearEntireCostmap service_name="local_costmap/clear_entirely_local_costmap"/>
        </Sequence>

        <!-- Level 3: Emergency escape -->
        <Sequence>
          <BackUp backup_dist="1.0" backup_speed="0.1"/>
          <ClearEntireCostmap service_name="local_costmap/clear_entirely_local_costmap"/>
          <ClearEntireCostmap service_name="global_costmap/clear_entirely_global_costmap"/>
        </Sequence>

      </ReactiveFallback>

    </RecoveryNode>
  </BehaviorTree>

</root>
