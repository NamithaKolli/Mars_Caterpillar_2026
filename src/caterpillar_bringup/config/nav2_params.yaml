#Add geometric footprint of robot
#REmove noise using nav2 denoise
#Add default_bt_xml_filename : "path/to/your/rover_bt.xml"
#Define all remaining plugins
#Verify each numerical parameter

#amcl:
 # ros__parameters:
  #  use_sim_time: False
    # ... (Standard AMCL params or use RTAB-Map for localization)

bt_navigator:
  ros__parameters:
    use_sim_time: False
    global_frame: map
    robot_base_frame: base_link
    odom_frame: odom
    default_nav_through_poses_bt_xml: ""
    # bt_xml_filename: /opt/ros/humble/share/nav2_bt_navigator/behavior_trees/navigate_to_pose_w_replanning_and_recovery.xml
    default_nav_to_pose_bt_xml: /opt/ros/humble/share/nav2_bt_navigator/behavior_trees/navigate_to_pose_w_replanning_and_recovery.xml
    always_reload_bt_xml: false
    goal_blackboard_id: goal
    goals_blackboard_id: goals
    path_blackboard_id: path

    # waypoint_statuses_blackboard_id: waypoint_statuses
    navigators: ['navigate_to_pose']

    navigate_to_pose:
      plugin: "nav2_bt_navigator::NavigateToPoseNavigator" # In Iron and older versions, "/" was used instead of "::"
      enable_groot_monitoring: false
      groot_server_port: 1667

    plugin_lib_names:
    
      # ---- Action nodes ----
      - nav2_compute_path_to_pose_action_bt_node
      - nav2_follow_path_action_bt_node
      - nav2_back_up_action_bt_node
      - nav2_spin_action_bt_node
      - nav2_wait_action_bt_node
      - nav2_clear_costmap_service_bt_node

      # ---- Control flow ----
      - nav2_pipeline_sequence_bt_node
      - nav2_rate_controller_bt_node
      - nav2_recovery_node_bt_node
      - nav2_round_robin_node_bt_node

      # ---- Condition nodes (CRITICAL) ----
      - nav2_goal_updated_condition_bt_node
      - nav2_goal_reached_condition_bt_node
      - nav2_initial_pose_received_condition_bt_node
      - nav2_is_stuck_condition_bt_node
      - nav2_is_path_valid_condition_bt_node
      - nav2_transform_available_condition_bt_node
      - nav2_time_expired_condition_bt_node
      - nav2_distance_traveled_condition_bt_node

controller_server:
  ros__parameters:
    use_sim_time: False
    controller_plugins: ["FollowPath"]
    
    FollowPath:
      # Rotation Shim wraps RPP to force in-place turns before moving
      plugin: "nav2_rotation_shim_controller::RotationShimController"
      primary_controller: "nav2_regulated_pure_pursuit_controller::RegulatedPurePursuitController"
      angular_dist_threshold: 0.785 # 45 degrees
      forward_sampling_distance: 0.5
      
      # RPP Specific Params
      desired_linear_vel: 0.4
      min_linear_vel: 0.1
      lookahead_dist: 0.6
      use_interpolation: true
      use_collision_detection: true
      
      # Crater & Boulder Safety (Regulation)
      use_cost_regulated_linear_velocity_scaling: true
      cost_scaling_dist: 0.5
      cost_scaling_gain: 1.0
      use_regulated_linear_velocity_scaling: true
      regulated_linear_scaling_min_speed: 0.1

planner_server:
  ros__parameters:
    use_sim_time: False
    planner_plugins: ["GridBased"]
    GridBased:
      plugin: "nav2_navfn_planner/NavfnPlanner"
      tolerance: 0.5
      use_astar: true
      allow_unknown: true # Critical so craters don't block planning

smoother_server:
  ros__parameters:
    use_sim_time: False
    smoother_plugins: ["simple_smoother"]
    simple_smoother:
      plugin: "nav2_smoother::SimpleSmoother"
      tolerance: 1.0e-10
      max_its: 1000
      w_landmark: 2.0
      w_smooth: 15.0 # High smoothing to keep camera stable

behavior_server:
  ros__parameters:
    use_sim_time: False
    local_frame: odom
    global_frame: map
    robot_base_frame: base_link
    behaviors: ["spin", "backup", "wait"]
    spin:
      plugin: "nav2_behaviors/Spin"
    backup:
      plugin: "nav2_behaviors/BackUp"
    wait:
      plugin: "nav2_behaviors/Wait"
      
lifecycle_manager_navigation:
  ros__parameters:
    autostart: true
    node_names: ['planner_server', 'controller_server', 'smoother_server', 'behavior_server', 'bt_navigator']

local_costmap:
  local_costmap:
    ros__parameters:
      update_frequency: 5.0
      publish_frequency: 2.0
      global_frame: odom
      robot_base_frame: base_link
      use_sim_time: False
      rolling_window: true
      width: 5
      height: 5
      resolution: 0.025
      # track_unknown_space: true
      # unknown_cost_value: 255
      # STVL replaces the standard obstacle/voxel layers
      plugins: ["stvl_layer", "inflation_layer"]

      stvl_layer:
        plugin: "spatio_temporal_voxel_layer/SpatioTemporalVoxelLayer"
        enabled: true
        publish_voxel_map: true
        voxel_decay: 1.0     # Time (s) for obstacles to disappear if not seen
        decay_model: 0       # 0=Linear decay (good for dynamic environments)
        voxel_size: 0.025     # Matches costmap resolution
        double_vdb: true    # Set true if you need extreme precision (uses more CPU)
        
        # CRATER DETECTION SETUP
        # We start the grid 50cm below the floor to see into holes
        map_save_path: ""
        min_z: -1.2         
        max_z: 0.8          
        
        observation_sources: depth_cam
        depth_cam:
          topic: /camera/realsense2_camera/depth/color/points
          sensor_frame: camera_depth_optical_frame
          data_type: "PointCloud2"
          marking: true
          clearing: true
          obstacle_max_range: 3.0
          raytrace_max_range: 3.5
          # These heights are relative to the 'min_z'/'max_z' above
          min_z: -1.2     # ground (-0.6) - crater depth (0.5)
          max_z: 0.8 
          min_obstacle_height: 0.05 
          max_obstacle_height: 0.6
          # Frustum clearing (STVL's "Secret Sauce")
          # These help clear obstacles that are no longer in the camera's view
          vertical_fov: 1.1    # Approx 65 degrees for D455
          horizontal_fov: 1.5  # Approx 86 degrees for D455
          decay_acceleration: 5.0 

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.5
        cost_scaling_factor: 5.0

global_costmap:
  global_costmap:
    ros__parameters:
      update_frequency: 1.0
      publish_frequency: 1.0
      global_frame: map
      robot_base_frame: base_link
      use_sim_time: False
      robot_radius: 0.25
      resolution: 0.05
      plugins: ["static_layer", "inflation_layer"]
      
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_subscribe_transient_local: True
        map_topic: /map # RTAB-Map Grid

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.7
        cost_scaling_factor: 2.5